<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cevdet â¤ï¸ Nehir</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff4b5c">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f2027;
  color: white;
}
header {
  padding: 15px;
  text-align: center;
  background: #203a43;
  font-weight: bold;
  position: sticky;
  top: 0;
}
#status {
  font-size: 12px;
}
.container {
  padding: 15px;
}
.message {
  padding: 12px;
  margin: 8px 0;
  border-radius: 15px;
  max-width: 75%;
  position: relative;
  font-size: 14px;
}
.cevdet {
  background: #2196f3;
  margin-left: auto;
}
.nehir {
  background: #ff4b5c;
}
.meta {
  font-size: 10px;
  opacity: 0.8;
  margin-top: 5px;
  text-align: right;
}
.tick {
  font-size: 11px;
  margin-left: 5px;
}
input {
  width: 65%;
  padding: 10px;
  border: none;
  border-radius: 20px;
}
button {
  padding: 10px;
  border: none;
  border-radius: 20px;
  background: #ff4b5c;
  color: white;
}
#memoryToggle {
  margin-top: 20px;
  cursor: pointer;
  text-align: center;
  font-weight: bold;
}
#memoryBox {
  display: none;
  margin-top: 10px;
  background: #1b2b34;
  padding: 10px;
  border-radius: 15px;
}
</style>
</head>

<body>

<header>
Cevdet â¤ï¸ Nehir
<div id="status">BaÄŸlanÄ±yor...</div>
</header>

<div class="container">

<div id="chat"></div>

<input id="messageInput" placeholder="BugÃ¼nkÃ¼ notunu yaz..." />
<button onclick="sendMessage()">GÃ¶nder</button>

<div id="memoryToggle">ğŸ“¦ AnÄ± Kutusunu AÃ§</div>
<div id="memoryBox">
<div id="memories"></div>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update, get, set } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBBpOuqC6_AQo5jCF0pF_l2jhMWS-vkdIY",
  authDomain: "cevdethenote.firebaseapp.com",
  databaseURL: "https://cevdethenote-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cevdethenote",
  storageBucket: "cevdethenote.firebasestorage.app",
  messagingSenderId: "53779979760",
  appId: "1:53779979760:web:8b7722fc6f80244027d135"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let user = "";
let today = new Date().toISOString().split("T")[0];
const chatRef = ref(db, "messages");

/* WebAuthn KayÄ±t ve GiriÅŸ */
async function registerCredential() {
  const publicKey = {
    challenge: Uint8Array.from(
      window.crypto.getRandomValues(new Uint8Array(32))
    ),
    rp: { name: "Cevdet & Nehir Chat" },
    user: {
      id: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(32))),
      name: prompt("KullanÄ±cÄ± adÄ±nÄ± gir (Cevdet veya Nehir)"),
      displayName: "Chat User",
    },
    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
  };

  const credential = await navigator.credentials.create({ publicKey });
  return credential;
}

async function loginWithCredential() {
  try {
    const credential = await navigator.credentials.get({
      publicKey: {
        challenge: new Uint8Array(32),
        allowCredentials: [],
        userVerification: "preferred"
      }
    });
    return credential;
  } catch (err) {
    console.log("Face ID ile giriÅŸ baÅŸarÄ±sÄ±z:", err);
    return null;
  }
}

async function authenticate() {
  if (!window.PublicKeyCredential) {
    user = prompt("Cevdet mi Nehir mi?").toLowerCase();
    return;
  }

  const choice = confirm("Face ID / Touch ID ile giriÅŸ yapmak ister misin?");
  if (choice) {
    const login = await loginWithCredential();
    if (!login) {
      const register = await registerCredential();
      if (register) {
        alert("Yeni Face ID kaydedildi! Bir daha Face ID ile giriÅŸ yapabilirsin.");
        user = prompt("Cevdet mi Nehir mi?").toLowerCase();
      }
    } else {
      user = prompt("Cevdet mi Nehir mi?").toLowerCase();
    }
  } else {
    user = prompt("Cevdet mi Nehir mi?").toLowerCase();
  }
}

await authenticate();

function formatTime(timestamp){
  const date = new Date(timestamp);
  return date.toLocaleDateString("tr-TR") + " " + 
         date.toLocaleTimeString("tr-TR",{hour:'2-digit',minute:'2-digit'});
}

onValue(chatRef, snapshot=>{
  const data = snapshot.val();
  document.getElementById("chat").innerHTML="";
  document.getElementById("memories").innerHTML="";

  if(!data) return;

  Object.entries(data).forEach(([key,msg])=>{
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", msg.user);
    msgDiv.innerHTML = `
      <b>${msg.user.toUpperCase()}</b><br>
      ${msg.text}
      <div class="meta">
        ${formatTime(msg.timestamp)}
        <span class="tick">${msg.read ? "âœ”âœ”" : "âœ”"}</span>
      </div>
    `;
    if(msg.date === today){
      document.getElementById("chat").appendChild(msgDiv);
    } else {
      document.getElementById("memories").appendChild(msgDiv);
    }

    if(msg.user !== user && !msg.read){
      update(ref(db,"messages/"+key), {read:true});
      if(navigator.vibrate) navigator.vibrate(200);
    }
  });

  window.scrollTo(0, document.body.scrollHeight);
  document.getElementById("status").innerText="Online ğŸŸ¢";
});

window.sendMessage = async function(){
  const text = document.getElementById("messageInput").value.trim();
  if(text==="") return;

  const dailyRef = ref(db,"daily/"+today+"/"+user);
  const snap = await get(dailyRef);

  if(snap.exists()){
    alert("BugÃ¼n sadece 1 mesaj hakkÄ±n var ğŸ’™");
    return;
  }

  await push(chatRef,{
    text:text,
    user:user,
    date:today,
    timestamp:Date.now(),
    read:false
  });

  await set(dailyRef,true);
  document.getElementById("messageInput").value="";
};

document.getElementById("memoryToggle").onclick = function(){
  const box = document.getElementById("memoryBox");
  if(box.style.display==="none"){
    box.style.display="block";
    this.innerText="ğŸ“¦ AnÄ± Kutusunu Kapat";
  }else{
    box.style.display="none";
    this.innerText="ğŸ“¦ AnÄ± Kutusunu AÃ§";
  }
};

</script>

</body>
</html>
